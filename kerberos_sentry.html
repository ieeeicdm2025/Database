<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="Academic Webpage" />
    <meta name="author" content="senli1073" />
    <title id="title"></title>

    <!-- Icon -->
    <link rel="icon" type="image/x-icon" href="static/assets/favicon.ico" />

    <!-- Bootstrap icons-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" />

    <!-- Google fonts-->
    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link href="https://fonts.googleapis.com/css2?family=Newsreader:ital,wght@0,600;1,600&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Mulish:ital,wght@0,300;0,500;0,600;0,700;1,300;1,500;1,600;1,700&amp;display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Kanit:ital,wght@0,400;1,400&amp;display=swap"
        rel="stylesheet" />

    <!-- Core theme CSS (includes Bootstrap)-->
    <link type="text/css" href="static/css/styles.css" rel="stylesheet" />
    <link type="text/css" href="static/css/main.css" rel="stylesheet" />

    <!-- Bootstrap core JS-->
    <script type="text/javascript" src="static/js/bootstrap.bundle.min.js"></script>

    <style>
        pre {
            background-color: #f4f4f4;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
            font-family: monospace;
        }

        code {
            color: #333;
        }
    </style>

    <!-- For Compatability -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>

    <!-- Markdown -->
    <script type="text/javascript" src="static/js/marked.min.js"></script>

    <!-- Mathematics -->
    <script>
        // See https://docs.mathjax.org/en/latest/index.html for more details.
        MathJax = {
            tex: {
                packages: {},              // extensions to use
                inlineMath: [              // start/end delimiter pairs for in-line math
                    ['$', '$'],
                    ['\\(', '\\)']
                ],
                displayMath: [             // start/end delimiter pairs for display math
                    ['$$', '$$'],
                    ['\\[', '\\]']
                ],
                processEscapes: false,      // use \$ to produce a literal dollar sign
                processEnvironments: true, // process \begin{xxx}...\end{xxx} outside math mode
                processRefs: true,         // process \ref{...} outside of math mode
                digits: /^(?:[0-9]+(?:\{,\}[0-9]{3})*(?:\.[0-9]*)?|\.[0-9]+)/,    // pattern for recognizing numbers
                tags: 'all',              // or 'ams' or 'all'
                tagSide: 'right',          // side for \tag macros
                tagIndent: '0.8em',        // amount to indent tags
                useLabelIds: true,         // use label name rather than tag for ids
                maxMacros: 10000,          // maximum number of macro substitutions per expression
                maxBuffer: 5 * 1024,       // maximum size for the internal TeX string (5K)
                // baseURL:                   // URL for use with links to tags (when there is a <base> tag in effect)
                // (document.getElementsByTagName('base').length === 0) ? '' : String(document.location).replace(/#.*$/, ''),
                formatError:               // function called when TeX syntax errors occur
                    (jax, err) => jax.formatError(err)
            }
        };
    </script>
    <script type="text/javascript" id="MathJax-script"
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
    <script type="text/javascript" id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- Core JS-->
    <script type="text/javascript" src="static/js/scripts.js"></script>
    <script type="text/javascript" src="static/js/js-yaml.min.js"></script>

</head>

<body id="page-top">
    <!-- Navigation-->
    <nav class="header navbar navbar-expand-lg navbar-light fixed-top shadow-sm" id="mainNav">
        <div class="container px-5">
            <a id="page-top-title" class="navbar-brand fw-bold" href="#page-top"></a>
            <!-- <a href="#page-top"><img src="static/assets/img/CUMT_LOGO.svg" style="width: 11rem;"></a> -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive"
                aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                MENU
                <i class="bi-list"></i>
            </button>
            <div class="collapse navbar-collapse" id="navbarResponsive">
                <ul class="navbar-nav ms-auto me-4 my-3 my-lg-0">
                    <li class="nav-item">
                        <a class="nav-link me-lg-3" href="index.html" style="font-size: 30px;">首页</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link me-lg-3" href="expriment.html" style="font-size: 30px;">实验指南</a>
                    </li>
                    <!-- <li class="nav-item">
                        <a class="nav-link me-lg-3" href="ppt.html" style="font-size: 30px;"><strong>PPT</strong></a>
                    </li> -->

                </ul>
            </div>
        </div>
    </nav>

    <!-- Top Section -->
    <section class="top-section" style="background-image: url('static/assets/img/background.jpeg');">
        <div class="top-section-content">
            <div class="container px-5">
                <h2 id="top-section-bg-text" class="text-white display-3 lh-1 font-alt"></h2>
            </div>
        </div>
    </section>
    <!-- Top Section -->

    <!-- Photo -->
    <div class="container px-5">
        <div id="avatar">
            <img class="shadow" src="static/assets/img/photo.png">
        </div>
    </div>
    <!-- Photo -->

    <!-- Home -->
    <section class="bg-gradient-primary-to-secondary-light mt5 md5" id="home">
        <div class="container px-5">
            <header>
                <h2 id="home-subtitle"> </h2>
                <!-- <span class="bi bi-list"></span> -->
            </header>
            <div class="main-body" id="home-md"></div>
        </div>
    </section>
    <!-- Home -->



    <!-- Awards -->
    <section class="bg-gradient-primary-to-secondary-light mt5 md5" id="awards">
        <div class="container px-5">
            <header>
                <h2 id="awards-subtitle" style="font-size: 48px;"><i class="bi bi-award-fill"></i> 实验指南(十二)：Kerberos和Sentry</h2>
            </header>

            <br>
            <li style="font-size: 20px;">本实验所用到的文件在山大云盘的存放位置为：.\实验材料\实验文件\exp11-CDH，所用到的文件如下：xcall.sh、xsync</li>

            <div style="height: 64px;"></div>

            <div class="main-body" id="awards-md">

                <h1 id="flink"><strong>Kerberos和Sentry</strong></h1>
                <div style="height: 32px;"></div>
                
                <h2 id="2flink"><strong>1、Kerberos</strong></h2>
                <p>Kerberos 是一种 网络身份认证协议，用于在非安全网络环境中实现安全的身份验证，防止敏感信息（如密码）在传输中被窃取。它广泛应用于企业级系统（如Hadoop集群）中，确保用户和服务之间的双向认证与通信安全。</p>
                <img src="static/assets/img/kerberos_sentry/kerberos.png" alt="kafka_achi" style="width: 100%; height: auto;">
                
                <p><strong>（1）Kerberos的核心角色</strong></p>
                <ul>
                    <li>客户端（Client）：请求访问服务的用户或应用程序。</li>
                </ul>

                <ul>
                    <li>服务端（Service Server）：提供具体服务的资源（如HDFS、HBase）。</li>
                </ul>

                <ul>
                    <li>密钥分发中心（KDC, Key Distribution Center）</li>
                    <li style="padding-left: 20px; list-style-position: inside;">认证服务器（AS, Authentication Server）：验证用户身份，发放临时票据（TGT）。</li>
                    <li style="padding-left: 20px; list-style-position: inside;">票据授权服务器（TGS, Ticket Granting Server）：根据TGT发放服务访问票据。</li>
                </ul>

                <p><strong>（2）Kerberos的关键术语</strong></p>
                <ul>
                    <li>票据（Ticket）：加密的凭证，用于证明用户身份和权限。</li>
                </ul>

                <ul>
                    <li>TGT（Ticket Granting Ticket）：用户首次登录后获得的临时票据，用于后续申请服务票据。</li>
                </ul>

                <ul>
                    <li>会话密钥（Session Key）：临时生成的加密密钥，用于客户端与服务端之间的通信加密。

                    </li>
                </ul>

                <ul>
                    <li>领域（Realm）：Kerberos管理的安全域（如EXAMPLE.COM），所有实体（用户、服务）需在同一领域内注册。</li>
                </ul>

                <h2 id="2flink"><strong>2、Sentry</strong></h2>

                <p>Sentry 是 Apache 开源的一个权限管理框架，专为 Hadoop 生态系统设计，用于控制用户或用户组对数据资源的访问权限（如 Hive 表、HDFS 目录、Impala 数据库等）。它通过统一的策略引擎实现 基于角色的访问控制（RBAC），是大数据平台（如 CDH）中实现数据安全的核心组件之一。</p>
                <img src="static/assets/img/kerberos_sentry/sentry.png" alt="flume_achi" style="width: 100%; height: auto;">    
                
                <br><br>

                <p><strong>（1）sentry的核心概念</strong></p>
                <ul>
                    <li>访问控制：Sentry 提供基于角色（Role-Based Access Control, RBAC）的权限管理，允许管理员为用户或组分配特定权限（如 SELECT、INSERT 等），控制对数据和资源的访问。</li>
                </ul>
                <ul>
                    <li>与 Hadoop 生态集成：在 CDH 中，Sentry 与 Kerberos 结合，形成完整的安全体系：Kerberos 负责“认证”（Authentication），Sentry 负责“授权”（Authorization）。</li>
                </ul>
                <ul>
                    <li>统一权限管理 ：Sentry 提供了一个集中式的权限管理模型，管理员可以通过 SQL 语句或界面管理权限，避免了分散在各个组件中的权限配置。</li>
                </ul>

                <p><strong>（2）sentry的工作原理（以Hive为例）</strong></p>
                <ul>
                    <li>用户已通过 Kerberos 认证，并通过 Beeline 或 Hue 提交 Hive 查询</li>
                </ul>
                <ul>  
                    <li>HiveServer2 接收查询请求后，调用 Sentry 插件</li>
                </ul>    
                <ul>
                    <li>sentry 插件将用户身份和查询语句发送到 Sentry Server，从而检查用户所属的角色对表的权限</li>
                </ul>    
                <ul>
                    <li>如果权限通过，Hive 继续编译和执行查询；如果权限不足，Hive 返回错误给用户。</li>
                </ul>
  

                
                <h2 id="3minikubeflink"><strong>3、在CHD上添加实验所需组件</strong></h2>
                

                <ul>
                    <li>我们先安装Hive</li>
                </ul>                
                <ul>
                    <li>我们在CDH的主界面点击添加服务</li>
                </ul>
                <img src="static/assets/img/kerberos_sentry/cdh_hive1.png" alt="flume_achi" style="width: 100%; height: auto;">


                <ul>
                    <li>选择Hive，再点击继续</li>
                </ul> 
                                
                <img src="static/assets/img/kerberos_sentry/cdh_hive2.png" alt="flume_achi" style="width: 100%; height: auto;">

                <ul>
                    <li>主机角色分配如下</li>
                </ul> 
                               
                <img src="static/assets/img/kerberos_sentry/cdh_hive3.png" alt="flume_achi" style="width: 100%; height: auto;">

                          
                <ul>
                    <li>对数据库做如下的配置，并测试连接</li>
                </ul>  
                <img src="static/assets/img/kerberos_sentry/cdh_hive4.png" alt="flume_achi" style="width: 100%; height: auto;">

                <ul>
                    <li>审核更改这里按默认配置就可以</li>
                </ul>       
                <img src="static/assets/img/kerberos_sentry/cdh_hive5.png" alt="flume_achi" style="width: 100%; height: auto;">


                <ul>
                    <li>然后等待配置完成即可</li>
                </ul>
                <img src="static/assets/img/kerberos_sentry/cdh_hive6.png" alt="flume_achi" style="width: 100%; height: auto;">

                <ul>
                    <li>到这里就完成hive的配置了</li>
                </ul>
                <img src="static/assets/img/kerberos_sentry/cdh_hive7.png" alt="flume_achi" style="width: 100%; height: auto;">

                <ul>
                    <li>接下来我们配置sentry</li>
                </ul>
                <ul>
                    <li>回到CDH的主界面，点击添加服务</li>
                </ul>     
                <img src="static/assets/img/kerberos_sentry/sentry1.png" alt="flume_achi" style="width: 100%; height: auto;">

                <ul>
                    <li>选择sentry</li>
                </ul> 
                <img src="static/assets/img/kerberos_sentry/sentry2.png" alt="flume_achi" style="width: 100%; height: auto;">    
                   

                <ul>
                    <li>主机角色分配如下</li>
                </ul>     
                <img src="static/assets/img/kerberos_sentry/sentry3.png" alt="flume_achi" style="width: 100%; height: auto;">   


                <ul>
                    <li>数据库设置如下，配置完点击测试连接，再点击继续</li>
                </ul>     
                <img src="static/assets/img/kerberos_sentry/sentry4.png" alt="flume_achi" style="width: 100%; height: auto;">   

                <ul>
                    <li>等待配置完成</li>
                </ul>     
                <img src="static/assets/img/kerberos_sentry/sentry5.png" alt="flume_achi" style="width: 100%; height: auto;"> 

                <ul>
                    <li>最后我们安装hue，在CDH的主界面点击添加服务</li>
                </ul>                
                <img src="static/assets/img/kerberos_sentry/cdh_hue1.png" alt="flume_achi" style="width: 100%; height: auto;">

                <ul>
                    <li>选择hue，再点击继续</li>
                </ul>                
                <img src="static/assets/img/kerberos_sentry/cdh_hue2.png" alt="flume_achi" style="width: 100%; height: auto;">

                <ul>
                    <li>勾选第一个，再点击继续</li>
                </ul>                
                <img src="static/assets/img/kerberos_sentry/cdh_hue3.png" alt="flume_achi" style="width: 100%; height: auto;">

                <ul>
                    <li>主机角色分配如下</li>
                </ul>                
                <img src="static/assets/img/kerberos_sentry/cdh_hue4.png" alt="flume_achi" style="width: 100%; height: auto;">

                <ul>
                    <li>对数据库做如下的配置，并测试连接</li>
                </ul>                
                <img src="static/assets/img/kerberos_sentry/cdh_hue5.png" alt="flume_achi" style="width: 100%; height: auto;">

                <ul>
                    <li>等待配置完成</li>
                </ul>                
                <img src="static/assets/img/kerberos_sentry/cdh_hue6.png" alt="flume_achi" style="width: 100%; height: auto;">



                <h2 id="3minikubeflink"><strong>4、Kerberos认证</strong></h2>

                <p><strong>（1）配置kerberos</strong></p>
                <ul>
                    <li>安装kerberos的server，只在hadoop101执行</li>
                </ul>
                <pre><code>yum install -y krb5-server krb5-workstation krb5-libs
</code></pre>                
<img src="static/assets/img/kerberos_sentry/kerberos_server.png" alt="flume_achi" style="width: 100%; height: auto;">

                <ul>
                    <li>安装kerberos的client，使用xcall.sh在所有虚拟机上安装</li>
                </ul> 
                <pre><code>xcall.sh yum install -y krb5-workstation krb5-libs
</code></pre>                   
<img src="static/assets/img/kerberos_sentry/kerberos_work_xcall.png" alt="flume_achi" style="width: 100%; height: auto;">

                <ul>
                    <li>而后在hadoop101的命令行编辑kdc.conf文件</li>
                </ul>  
                <pre><code>nano /var/kerberos/krb5kdc/kdc.conf
</code></pre>            
                <ul>
                    <li>修改操作如下</li>
                </ul>  
                <pre><code># EXAMPLE.COM修改为HADOOP.COM 
# 添加如下字段，用于配置生命周期
max_life = 1d
max_renewable_life = 7d
# 去掉aes256-cts:normal，这个需要额外的jar包
</code></pre>  
                <ul>
                    <li>kdc.conf文件的完整内容如下</li>
                </ul>  
<img src="static/assets/img/kerberos_sentry/kerberos_kdc.png" alt="flume_achi" style="width: 100%; height: auto;">      

                <ul>
                    <li>接着编辑krb5.conf文件</li>
                </ul>  
                <pre><code>nano /etc/krb5.conf
</code></pre>              
                <ul>
                    <li>修改操作如下</li>
                </ul>  
                <pre><code># 放开注释掉的default_realm = EXAMPLE.COM，并修改EXAMPLE.COM为HADOOP.COM 
# 注释掉这一行：default_ccache_name = KEYRING:persistent:%{uid}
# 添加udp配置：udp_preference_limit = 1
# 放开[realms]下的注释，并配置为：
HADOOP.COM = {
    kdc = hadoop101
    admin_server = hadoop101
  }
</code></pre>  

                <ul>
                    <li>krb5.conf文件的完整内容如下</li>
                </ul>
<img src="static/assets/img/kerberos_sentry/kerberos_krb5.png" alt="flume_achi" style="width: 100%; height: auto;">  

                <ul>
                    <li>分发krb5.conf文件</li>
                </ul>       
                <pre><code>xsync /etc/krb5.conf
</code></pre>              
<img src="static/assets/img/kerberos_sentry/kerberos_xsync.png" alt="flume_achi" style="width: 100%; height: auto;">

                <ul>
                    <li>生成kerberos数据库</li>
                </ul>                
                <pre><code>kdb5_util create -s
</code></pre>  
                <ul>
                    <li>而后设置密码，可以也设为000000</li>
                </ul>  
<img src="static/assets/img/kerberos_sentry/kerberos_db.png" alt="flume_achi" style="width: 100%; height: auto;">
                <ul>
                    <li>赋予Kerberos管理员所有权限，编辑下面文件，将EXAMPLE更改为为HADOOP</li>
                </ul>                
                <pre><code>nano /var/kerberos/krb5kdc/kadm5.acl
</code></pre>    
<img src="static/assets/img/kerberos_sentry/kerberos_acl.png" alt="flume_achi" style="width: 100%; height: auto;">

                <ul>
                    <li>启动kerberos服务</li>
                </ul>                
                <pre><code>systemctl start krb5kdc
systemctl start kadmin
</code></pre>    
                <ul>
                    <li>查看启动状态</li>
                </ul>                
                <pre><code>systemctl status krb5kdc
systemctl status kadmin
</code></pre>    
                <ul>
                    <li>设置开机自启</li>
                </ul>                
                <pre><code>systemctl enable krb5kdc
systemctl enable kadmin
</code></pre>    
<img src="static/assets/img/kerberos_sentry/kerberos_status.png" alt="flume_achi" style="width: 100%; height: auto;">

                <p><strong>（2）Kerberos数据库操作</strong></p>
                <ul>
                    <li>本地登录</li>
                </ul>                
                <pre><code>kadmin.local
</code></pre> 
                <ul>
                    <li>创建kerberos主体，这里需要设置密码，可以继续使用：000000</li>
                </ul>                
                <pre><code>addprinc admin/admin
</code></pre> 
                <ul>
                    <li>查看所有主体</li>
                </ul>                
                <pre><code>list_principals
</code></pre> 

                <ul>
                    <li>退出登录</li>
                </ul>                
                <pre><code>quit
</code></pre> 

<img src="static/assets/img/kerberos_sentry/kerberos_database.png" alt="flume_achi" style="width: 100%; height: auto;">

                <ul>
                    <li>也可以采用-q参数的方式，而不进入kadmin.local命令行</li>
                </ul>
                <pre><code>kadmin.local -q "addprinc admin/admin"
kadmin.local -q "list_principals"
</code></pre> 

<img src="static/assets/img/kerberos_sentry/kerberos_q.png" alt="flume_achi" style="width: 100%; height: auto;">

                <p><strong>（3）Kerberos主体认证</strong></p>
                <ul>
                    <li>两种认证方式</li>
                </ul>   
                <ul>
                    <li>第一种是使用knit认证</li>
                </ul> 
                <ul>
                    <li>先查看未认证时的情况</li>
                </ul>              
                <pre><code>klist
</code></pre> 
                <ul>
                    <li>进行认证，而后输入密码000000，可以看到已经认证成功了</li>
                </ul>                
                <pre><code>kinit admin/admin
</code></pre> 
                <ul>
                    <li>再次查看凭据，可以看到已经有凭据了，表明认证成功</li>
                </ul>                
                <pre><code>klist
</code></pre> 

                <ul>
                    <li>而后我们销毁认证以使用另一种认证方式</li>
                </ul>                
                <pre><code>kdestroy
</code></pre> 

                <ul>
                    <li>再次查看，当前已经没有认证了</li>
                </ul>                
                <pre><code>klist
</code></pre> 

                <ul>
                    <li>第二种是keytab密钥文件认证</li>
                </ul>   
                <ul>
                    <li>生成主体admin/admin的keytab文件到指定目录/root/admin.keytab</li>
                </ul>                
                <pre><code>kadmin.local -q "xst -norandkey -k /root/admin.keytab admin/admin@HADOOP.COM"
</code></pre> 

                <ul>
                    <li>使用keytab进行认证</li>
                </ul>                
                <pre><code>kinit -kt /root/admin.keytab admin/admin
</code></pre> 

                <ul>
                    <li>再次查看认证凭证</li>
                </ul>                
                <pre><code>klist
</code></pre> 
<img src="static/assets/img/kerberos_sentry/kerberos_two.png" alt="flume_achi" style="width: 100%; height: auto;">

                <p><strong>（4）CDH启用Kerberos安全认证</strong></p>
                
                <ul>
                    <li>先在hadoop101上，为CM创建管理员主体/实例，而后设置密码为：000000</li>
                </ul>                
                <pre><code>kadmin.local -q "addprinc cloudera-scm/admin"
</code></pre> 
<img src="static/assets/img/kerberos_sentry/kerberos_create_scm.png" alt="flume_achi" style="width: 100%; height: auto;">

                <p><strong>（4）CDH启用Kerberos安全认证</strong></p>
                <ul>
                    <li>而后在web页面启动kerberos</li>
                </ul>                
                <pre><code>
</code></pre> 
<img src="static/assets/img/kerberos_sentry/kerberos_cdh1.png" alt="flume_achi" style="width: 100%; height: auto;">

                
                <ul>
                    <li>全部勾选，再点击继续</li>
                </ul>                
<img src="static/assets/img/kerberos_sentry/kerberos_cdh2.png" alt="flume_achi" style="width: 100%; height: auto;">

                
                <ul>
                    <li>kdc信息的具体配置如下</li>
                </ul>                
<img src="static/assets/img/kerberos_sentry/kerberos_cdh3.png" alt="flume_achi" style="width: 100%; height: auto;">

                
                <ul>
                    <li>无需勾选，点击继续</li>
                </ul>     
<img src="static/assets/img/kerberos_sentry/kerberos_cdh4.png" alt="flume_achi" style="width: 100%; height: auto;">

                <ul>
                    <li>这里输入我们刚刚创建的主体：cloudera-scm/admin，以及密码：000000</li>
                </ul>                
<img src="static/assets/img/kerberos_sentry/kerberos_cdh5.png" alt="flume_achi" style="width: 100%; height: auto;">

                <ul>
                    <li>点击继续</li>
                </ul>                
<img src="static/assets/img/kerberos_sentry/kerberos_cdh6.png" alt="flume_achi" style="width: 100%; height: auto;">

                <ul>
                    <li>点击继续</li>
                </ul>                
<img src="static/assets/img/kerberos_sentry/kerberos_cdh7.png" alt="flume_achi" style="width: 100%; height: auto;">

                <ul>
                    <li>等待配置完成</li>
                </ul>                
<img src="static/assets/img/kerberos_sentry/kerberos_cdh8.png" alt="flume_achi" style="width: 100%; height: auto;">

                <ul>
                    <li>这里就已经成功在cdh上启用kerberos了</li>
                </ul>                
<img src="static/assets/img/kerberos_sentry/kerberos_cdh9.png" alt="flume_achi" style="width: 100%; height: auto;">
                

                <ul>
                    <li>我们可以点击管理-安全以查看生成的kerberos凭据</li>
                </ul>                
<img src="static/assets/img/kerberos_sentry/kerberos_cdh10.png" alt="flume_achi" style="width: 100%; height: auto;">
<br><br>
<img src="static/assets/img/kerberos_sentry/kerberos_cdh11.png" alt="flume_achi" style="width: 100%; height: auto;">
                
                <p><strong>（5）测试Kerberos安全认证</strong></p>
                <ul>
                    <li>先销毁凭据</li>
                </ul>                
                <pre><code>kdestroy
</code></pre> 

                <ul>
                    <li>查看凭据是否被销毁，可以看到当前没有凭据</li>
                </ul>                
                <pre><code>klist
</code></pre> 

                <ul>
                    <li>查看hdfs，可以看到没有权限</li>
                </ul>     
                <pre><code>hadoop fs -ls /
</code></pre>        

                <ul>
                    <li>创建用户</li>
                </ul>     
                <pre><code>kadmin.local -q "addprinc test/test@HADOOP.COM"
</code></pre>    
                <ul>
                    <li>设置密码：000000</li>
                </ul>    

                <ul>
                    <li>进行用户认证</li>
                </ul>     
                <pre><code>kinit test/test@HADOOP.COM
</code></pre>    
                <ul>
                    <li>输入刚刚设置的密码：000000</li>
                </ul> 

                <ul>
                    <li>再次访问hdfs，发现可以访问了</li>
                </ul>     
                <pre><code>hadoop fs -ls /
</code></pre>        
<img src="static/assets/img/kerberos_sentry/kerberos_test.png" alt="flume_achi" style="width: 100%; height: auto;">
<br><br>


                <h2 id="3minikubeflink"><strong>5、配置Sentry</strong></h2>
                
                <p><strong>（1）修改相关配置</strong></p>
                <ul>
                    <li>回到CDH的主界面，点击hive</li>
                </ul>     
<img src="static/assets/img/kerberos_sentry/sentry_hive1.png" alt="flume_achi" style="width: 100%; height: auto;"> 
                
                <ul>
                    <li>点击配置，并在搜索框输入：hiveserver2 启用模拟，而后取消勾选并保存更改</li>
                </ul>     
<img src="static/assets/img/kerberos_sentry/sentry_hive2.png" alt="flume_achi" style="width: 100%; height: auto;"> 

                <ul>
                    <li>而后继续在搜索框搜索：启用数据库中的存储通知，勾选并保存更改</li>
                </ul>     
<img src="static/assets/img/kerberos_sentry/sentry_hive3.png" alt="flume_achi" style="width: 100%; height: auto;"> 

                <ul>
                    <li>而后继续在搜索框搜索：sentry，勾选sentry并保存更改</li>
                </ul>     
<img src="static/assets/img/kerberos_sentry/sentry_hive4.png" alt="flume_achi" style="width: 100%; height: auto;"> 

                <ul>
                    <li>然后我们回到CDH主界面并选择hdfs</li>
                </ul>     
<img src="static/assets/img/kerberos_sentry/sentry_hdfs1.png" alt="flume_achi" style="width: 100%; height: auto;"> 

                <ul>
                    <li>点击配置，并在搜索框中输入：启用访问控制列表，勾选并保存更改</li>
                </ul>     
<img src="static/assets/img/kerberos_sentry/sentry_hdfs2.png" alt="flume_achi" style="width: 100%; height: auto;"> 

                <ul>
                    <li>而后在搜索框中输入：启用 sentry 同步，勾选并保存更改</li>
                </ul>     
<img src="static/assets/img/kerberos_sentry/sentry_hdfs3.png" alt="flume_achi" style="width: 100%; height: auto;"> 

                <ul>
                    <li>回到主界面，点击重启，应用更改项</li>
                </ul>     
<img src="static/assets/img/kerberos_sentry/sentry_restart1.png" alt="flume_achi" style="width: 100%; height: auto;"> 

                <ul>
                    <li>点击重启过时服务</li>
                </ul>     
<img src="static/assets/img/kerberos_sentry/sentry_restart2.png" alt="flume_achi" style="width: 100%; height: auto;"> 

                <ul>
                    <li>点击立即重启</li>
                </ul>     
<img src="static/assets/img/kerberos_sentry/sentry_restart3.png" alt="flume_achi" style="width: 100%; height: auto;"> 

                <ul>
                    <li>等待重启完成</li>
                </ul>     
<img src="static/assets/img/kerberos_sentry/sentry_restart4.png" alt="flume_achi" style="width: 100%; height: auto;"> 

                <p><strong>（2）测试sentry</strong></p>

                <ul>
                    <li>我们回到连接hadoop101的命令行，使用xcall.sh在所有虚拟机创建角色并设置密码</li>
                </ul>     
                <pre><code>xcall.sh "useradd reader && echo 000000 | passwd --stdin reader"
xcall.sh "useradd writer && echo 000000 | passwd --stdin writer"
</code></pre>        
<img src="static/assets/img/kerberos_sentry/sentry_user_xcall.png" alt="flume_achi" style="width: 100%; height: auto;"> 

                <ul>
                    <li>而后我们回到CDH的主界面，点击hue</li>
                </ul>     
<img src="static/assets/img/kerberos_sentry/sentry_hue1.png" alt="flume_achi" style="width: 100%; height: auto;"> 

                <ul>
                    <li>再进入hue的webui</li>
                </ul>     
<img src="static/assets/img/kerberos_sentry/sentry_hue2.png" alt="flume_achi" style="width: 100%; height: auto;"> 

                <ul>
                    <li>这里可能会有进入hue的webui失败的问题，像下面这样，这里是因为我们没有在自己电脑的windows环境下配置hadoop101与其IP对应，因此无法识别，只需要将这里的hadoop101用它对应的IP替换就可以了</li>
                </ul>     
<img src="static/assets/img/kerberos_sentry/sentry_hue5.png" alt="flume_achi" style="width: 100%; height: auto;"> 

                <ul>
                    <li>当然也可以更改我们windows环境下的hosts文件，路径为：C:\Windows\System32\drivers\etc\hosts，添加如下内容并保存，注意这里的ip需要改成自己配置虚拟机时使用的ip</li>
                </ul>     
                <pre><code>192.168.10.101 hadoop101
192.168.10.102 hadoop102
192.168.10.103 hadoop103
</code></pre>
<img src="static/assets/img/kerberos_sentry/sentry_hue6.png" alt="flume_achi" style="width: 100%; height: auto;"> 

                <ul>
                    <li>使用hive作为用户名，000000作为初始密码登录hue</li>
                </ul>     
<img src="static/assets/img/kerberos_sentry/sentry_hue3.png" alt="flume_achi" style="width: 100%; height: auto;"> 

                <ul>
                    <li>点击右上角的管理用户</li>
                </ul>     
<img src="static/assets/img/kerberos_sentry/sentry_hue4.png" alt="flume_achi" style="width: 100%; height: auto;"> 

                <ul>
                    <li>添加reader组和writer组</li>
                </ul>     
<img src="static/assets/img/kerberos_sentry/sentry_group1.png" alt="flume_achi" style="width: 100%; height: auto;">
<br><br> 
<img src="static/assets/img/kerberos_sentry/sentry_group2.png" alt="flume_achi" style="width: 100%; height: auto;"> 
<br><br>
<img src="static/assets/img/kerberos_sentry/sentry_group3.png" alt="flume_achi" style="width: 100%; height: auto;"> 

                <ul>
                    <li>添加reader用户和writer用户到对应的组里</li>
                </ul>     
<img src="static/assets/img/kerberos_sentry/sentry_user1.png" alt="flume_achi" style="width: 100%; height: auto;">
<br><br>
<img src="static/assets/img/kerberos_sentry/sentry_user2.png" alt="flume_achi" style="width: 100%; height: auto;">
<br><br>
<img src="static/assets/img/kerberos_sentry/sentry_user3.png" alt="flume_achi" style="width: 100%; height: auto;">
<br><br>
<img src="static/assets/img/kerberos_sentry/sentry_user4.png" alt="flume_achi" style="width: 100%; height: auto;">
<br><br>
<img src="static/assets/img/kerberos_sentry/sentry_user5.png" alt="flume_achi" style="width: 100%; height: auto;"> 

                <ul>
                    <li>添加hive组，并将hive用户添加到组里</li>
                </ul>     
<img src="static/assets/img/kerberos_sentry/sentry_hive.png" alt="flume_achi" style="width: 100%; height: auto;"> 

                <ul>
                    <li>我们回到hadoop101的命令行，先为hive服务建立kerberos凭证，再使用hive作为用户获取凭证，而后进入hive，创建student表</li>
                </ul>     
                <pre><code>kadmin.local -q "addprinc hive/hive@HADOOP.COM"
kinit hive/hive@HADOOP.COM
hive

create table student(
id string comment '学号',
name string comment '姓名',
sex string comment '性别',
age string comment '年龄'
) comment '学生表';
</code></pre>
<img src="static/assets/img/kerberos_sentry/sentry_init.png" alt="flume_achi" style="width: 100%; height: auto;"> 

                <ul>
                    <li>然后我们回到hue的webui，点击安全性</li>
                </ul>     
<img src="static/assets/img/kerberos_sentry/sentry_safe.png" alt="flume_achi" style="width: 100%; height: auto;"> 

                <ul>
                    <li>先点击Roles，再点击“+”号，创建reader_role和writer_role，分别授予select和insert权限</li>
                </ul>     
<img src="static/assets/img/kerberos_sentry/sentry_role1.png" alt="flume_achi" style="width: 100%; height: auto;"> 
<br><br>
<img src="static/assets/img/kerberos_sentry/sentry_role2.png" alt="flume_achi" style="width: 100%; height: auto;"> 
<br><br>
<img src="static/assets/img/kerberos_sentry/sentry_role3.png" alt="flume_achi" style="width: 100%; height: auto;"> 

                <ul>
                    <li>接着我们点击右上角，注销当前的hive用户</li>
                </ul>     
<img src="static/assets/img/kerberos_sentry/sentry_quit1.png" alt="flume_achi" style="width: 100%; height: auto;"> 

                <ul>
                    <li>使用reader用户登录，密码使用000000</li>
                </ul>     
<img src="static/assets/img/kerberos_sentry/sentry_reader1.png" alt="flume_achi" style="width: 100%; height: auto;"> 

                <ul>
                    <li>进行查询，成功</li>
                </ul>     
                <pre><code>select * from student
</code></pre>
<img src="static/assets/img/kerberos_sentry/sentry_reader2.png" alt="flume_achi" style="width: 100%; height: auto;"> 

                <ul>
                    <li>进行插入，失败，报错为权限不够</li>
                </ul>   
                <pre><code>insert into student values('1','孙悟空','男','100');
</code></pre>  
<img src="static/assets/img/kerberos_sentry/sentry_reader3.png" alt="flume_achi" style="width: 100%; height: auto;"> 

                <ul>
                    <li>接着我们点击右上角，注销当前的reader用户</li>
                </ul>     
<img src="static/assets/img/kerberos_sentry/sentry_quit2.png" alt="flume_achi" style="width: 100%; height: auto;"> 

                <ul>
                    <li>使用writer用户登录，密码使用000000</li>
                </ul>     
<img src="static/assets/img/kerberos_sentry/sentry_writer1.png" alt="flume_achi" style="width: 100%; height: auto;"> 

                <ul>
                    <li>进行查询，失败，报错为权限不够</li>
                </ul> 
                <pre><code>select * from student
</code></pre>    
<img src="static/assets/img/kerberos_sentry/sentry_writer2.png" alt="flume_achi" style="width: 100%; height: auto;"> 

                <ul>
                    <li>进行插入</li>
                </ul>
                <pre><code>insert into student values('1','孙悟空','男','100');
</code></pre>  
                <ul>
                    <li>由于资源限制，这里AM请求的最小资源无法满足，因此YARN拒绝了该任务的启动请求，但是可以看到该命令已经转化为了mapreduce任务，没有出现权限报错，只要能据此了解sentry的工作方式即可</li>
                </ul>         
<img src="static/assets/img/kerberos_sentry/sentry_writer3.png" alt="flume_achi" style="width: 100%; height: auto;"> 
<br><br>
<img src="static/assets/img/kerberos_sentry/sentry_writer4.png" alt="flume_achi" style="width: 100%; height: auto;"> 
            </div>

        </div>
    </section>
    <!-- Awards -->


    <!-- Footer-->
    <footer class="bg-bottom text-center py-5">
        <div class="container px-5">

        </div>
    </footer>

</body>

</html>