<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="Academic Webpage" />
    <meta name="author" content="senli1073" />
    <title id="title"></title>

    <!-- Icon -->
    <link rel="icon" type="image/x-icon" href="static/assets/favicon.ico" />

    <!-- Bootstrap icons-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" />

    <!-- Google fonts-->
    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link href="https://fonts.googleapis.com/css2?family=Newsreader:ital,wght@0,600;1,600&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Mulish:ital,wght@0,300;0,500;0,600;0,700;1,300;1,500;1,600;1,700&amp;display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Kanit:ital,wght@0,400;1,400&amp;display=swap"
        rel="stylesheet" />

    <!-- Core theme CSS (includes Bootstrap)-->
    <link type="text/css" href="static/css/styles.css" rel="stylesheet" />
    <link type="text/css" href="static/css/main.css" rel="stylesheet" />

    <!-- Bootstrap core JS-->
    <script type="text/javascript" src="static/js/bootstrap.bundle.min.js"></script>

    <style>
        pre {
            background-color: #f4f4f4;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
            font-family: monospace;
        }

        code {
            color: #333;
        }
    </style>

    <!-- For Compatability -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>

    <!-- Markdown -->
    <script type="text/javascript" src="static/js/marked.min.js"></script>

    <!-- Mathematics -->
    <script>
        // See https://docs.mathjax.org/en/latest/index.html for more details.
        MathJax = {
            tex: {
                packages: {},              // extensions to use
                inlineMath: [              // start/end delimiter pairs for in-line math
                    ['$', '$'],
                    ['\\(', '\\)']
                ],
                displayMath: [             // start/end delimiter pairs for display math
                    ['$$', '$$'],
                    ['\\[', '\\]']
                ],
                processEscapes: false,      // use \$ to produce a literal dollar sign
                processEnvironments: true, // process \begin{xxx}...\end{xxx} outside math mode
                processRefs: true,         // process \ref{...} outside of math mode
                digits: /^(?:[0-9]+(?:\{,\}[0-9]{3})*(?:\.[0-9]*)?|\.[0-9]+)/,    // pattern for recognizing numbers
                tags: 'all',              // or 'ams' or 'all'
                tagSide: 'right',          // side for \tag macros
                tagIndent: '0.8em',        // amount to indent tags
                useLabelIds: true,         // use label name rather than tag for ids
                maxMacros: 10000,          // maximum number of macro substitutions per expression
                maxBuffer: 5 * 1024,       // maximum size for the internal TeX string (5K)
                // baseURL:                   // URL for use with links to tags (when there is a <base> tag in effect)
                // (document.getElementsByTagName('base').length === 0) ? '' : String(document.location).replace(/#.*$/, ''),
                formatError:               // function called when TeX syntax errors occur
                    (jax, err) => jax.formatError(err)
            }
        };
    </script>
    <script type="text/javascript" id="MathJax-script"
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
    <script type="text/javascript" id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- Core JS-->
    <script type="text/javascript" src="static/js/scripts.js"></script>
    <script type="text/javascript" src="static/js/js-yaml.min.js"></script>

</head>

<body id="page-top">
    <!-- Navigation-->
    <nav class="header navbar navbar-expand-lg navbar-light fixed-top shadow-sm" id="mainNav">
        <div class="container px-5">
            <a id="page-top-title" class="navbar-brand fw-bold" href="#page-top"></a>
            <!-- <a href="#page-top"><img src="static/assets/img/CUMT_LOGO.svg" style="width: 11rem;"></a> -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive"
                aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                MENU
                <i class="bi-list"></i>
            </button>
            <div class="collapse navbar-collapse" id="navbarResponsive">
                <ul class="navbar-nav ms-auto me-4 my-3 my-lg-0">
                    <li class="nav-item">
                        <a class="nav-link me-lg-3" href="index.html" style="font-size: 30px;">首页</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link me-lg-3" href="expriment.html" style="font-size: 30px;">实验指南</a>
                    </li>
                    <!-- <li class="nav-item">
                        <a class="nav-link me-lg-3" href="ppt.html" style="font-size: 30px;"><strong>PPT</strong></a>
                    </li> -->

                </ul>
            </div>
        </div>
    </nav>

    <!-- Top Section -->
    <section class="top-section" style="background-image: url('static/assets/img/background.jpeg');">
        <div class="top-section-content">
            <div class="container px-5">
                <h2 id="top-section-bg-text" class="text-white display-3 lh-1 font-alt"></h2>
            </div>
        </div>
    </section>
    <!-- Top Section -->

    <!-- Photo -->
    <div class="container px-5">
        <div id="avatar">
            <img class="shadow" src="static/assets/img/photo.png">
        </div>
    </div>
    <!-- Photo -->

    <!-- Home -->
    <section class="bg-gradient-primary-to-secondary-light mt5 md5" id="home">
        <div class="container px-5">
            <header>
                <h2 id="home-subtitle"> </h2>
                <!-- <span class="bi bi-list"></span> -->
            </header>
            <div class="main-body" id="home-md"></div>
        </div>
    </section>
    <!-- Home -->



    <!-- Awards -->
    <section class="bg-gradient-primary-to-secondary-light mt5 md5" id="awards">
        <div class="container px-5">
            <header>
                <h2 id="awards-subtitle" style="font-size: 48px;"><i class="bi bi-award-fill"></i> 实验指南(六)：SparkSQL
                </h2>
            </header>

            <div style="height: 64px;"></div>

            <div class="main-body" id="awards-md">


                <h1 id="sparksql"><strong>SparkSQL（<a
                    href="https://spark.apache.org/sql/" target="_blank">官网</a>）</strong></h1>
                <div style="height: 32px;"></div>
                <h2 id="1-4"><strong>1、简介</strong></h2>
                <p>Spark SQL 是 Apache Spark 提供的一个模块，用于处理结构化数据，它使得用户能够在 Spark 上执行 SQL 查询、访问数据源、以及将 Spark 与 SQL 生态系统（如
                    Hive）无缝集成。</p>
                <img src="static/assets/img/sparksql_hive/sparksql_achi.png" alt="sparksql_achi" style="width: 100%; height: auto;"/>
                <br><br>
                <h2 id="2sparksql"><strong>2、SparkSQL的核心概念</strong></h2>
                <p><strong>（1）Catalyst 查询优化器</strong></p>
                <ul>
                    <li>Catalyst 是 Spark SQL 的核心组件之一，它是一个通用的查询优化器，用于优化查询计划。优化过程可以分为下面几个阶段：</li>
                    <li>解析：将 SQL 查询解析成逻辑查询计划</li>
                    <li>分析：将逻辑查询计划分析成物理查询计划</li>
                    <li>优化：使用多种规则对查询计划进行优化（例如，投影下推、谓词下推等）</li>
                    <li>生成代码：根据物理计划生成 Java 字节码进行执行</li>
                </ul>
                
                <p><strong>（2）Tungsten 执行引擎</strong></p>
                <ul>
                    <li>Tungsten 是 Spark SQL 的执行引擎，它主要关注物理执行优化，旨在通过内存管理、代码生成和硬件优化等技术提升 Spark SQL 的执行效率。</li>
                </ul>
                <p><strong>（3）DataFrame 和 DataSet</strong></p>
                <ul>
                    <li>DataFrame：是 Spark 中的一个不可变的分布式数据集，它类似于关系型数据库中的表或数据框。DataFrame API 提供了基于 SQL
                        查询的数据操作接口，支持对结构化数据进行查询、过滤、聚合等操作。</li>
                    <li>DataSet：是 DataFrame 的强类型版本，它结合了 RDD 和 DataFrame 的优点，能够提供编译时类型检查，同时支持 SQL 查询优化。</li>
                </ul>
                <h2 id="3minikubesparksql"><strong>3、使用minikube部署SparkSQL</strong></h2>
                <p><strong>（1）配置 <a
                    href="hadoop.html" target="_blank">Hadoop</a> 和 <a
                    href="spark.html" target="_blank">Spark</a> 的环境</strong>
                </p>
                
                <ul>
                    <li>查看pod状态，确认已正常运行</li>
                </ul>
                <pre><code>kubectl get pods
</code></pre>
<img src="static/assets/img/sparksql/hadoop_spark.png" alt="hadoop_spark" style="width: 100%; height: auto;"/>

                <p><strong>（2）使用SparkSQL进行查询</strong></p>
                <ul>
                    <li>这里我们用到的依然是data1.txt和data2.txt两个文件，可以参考hive的<a
                        href="hive.html" target="_blank">文档</a>中所提及的方式将这两个文件上传到hdfs，只需把用到的pod名称由hive的pod名称更改为nodemanager的pod名称就可以了</li>
                </ul>

                <!-- <pre><code>kubectl cp data1.txt nodemanager-0:/opt/spark/work-dir
kubectl cp data2.txt nodemanager-0:/opt/spark/work-dir
</code></pre>
<img src="static/assets/img/sparksql/copy.png" alt="copy" style="width: 100%; height: auto;"/>
                <ul>
                    <li>进入nodemanager所在的pod</li>
                </ul>
                <pre><code>kubectl exec -it nodemanager-0 -- bash
</code></pre>

                <ul>
                    <li>在hdfs上创建/input文件夹以存放查询需要导入的文件</li>
                </ul>
                <pre><code>hdfs dfs -mkdir /input
</code></pre>

                <ul>
                    <li>将所需文件上传至HDFS</li>
                </ul>
                <pre><code>hdfs dfs -put data1.txt /input
hdfs dfs -put data2.txt /input
</code></pre>
<img src="static/assets/img/sparksql/upload.png" alt="upload" style="width: 100%; height: auto;"/> -->

                <ul>
                    <li>上传完文件后，我们进入nodemanager所在的pod</li>
                </ul>
                <pre><code>kubectl exec -it nodemanager-0 -- bash
</code></pre>

                <ul>
                    <li>启动sparksql</li>
                </ul>
                <pre><code>spark-sql
</code></pre>
<img src="static/assets/img/sparksql/comein.png" alt="comein" style="width: 100%; height: auto;"/>

                <p><strong>（3）进行专利文献数据查询cite75_99.txt</strong></p>
                <ul>
                    <li>建立表格并导入文件数据</li>
                </ul>
                <pre><code>CREATE TABLE patent_citation (
    CITING STRING,
    CITED STRING
)
USING csv
OPTIONS (path '/input/data1.txt', header 'false', delimiter ',');
</code></pre>
<img src="static/assets/img/sparksql/create1.png" alt="create1" style="width: 100%; height: auto;"/>

                <ul>
                    <li>查询一 被引用列表</li>
                </ul>
                <pre><code>SELECT 
    cited, 
    CONCAT_WS(',', COLLECT_LIST(CITING)) AS citing_list
FROM 
    patent_citation
GROUP BY 
    cited limit 10;
</code></pre>
<img src="static/assets/img/sparksql/query1.png" alt="query1" style="width: 100%; height: auto;"/>
                <ul>
                    <li>查询二 被引用次数</li>
                </ul>
                <pre><code>SELECT
    cited,
    COUNT(*) AS citing_count
FROM
    patent_citation
GROUP BY
    cited limit 10;
</code></pre>
<img src="static/assets/img/sparksql/query2.png" alt="query2" style="width: 100%; height: auto;"/>
                <ul>
                    <li>查询三 被引用次数直方图</li>
                </ul>
                <pre><code>SELECT 
    ct, 
    COUNT(*) AS group_count
FROM (
    SELECT 
        cited, 
        COUNT(*) AS ct
    FROM 
        patent_citation
    GROUP BY 
        cited
) AS cite_count
GROUP BY 
    ct
ORDER BY ct;
</code></pre>
<img src="static/assets/img/sparksql/query3.png" alt="query3" style="width: 100%; height: auto;"/>
<br><br>
                <p><strong>（4）进行专利文献数据查询apat63_99.txt</strong></p>
                <ul>
                    <li>先导入表</li>
                </ul>
                <pre><code>CREATE TABLE patent_metadata (
    PATENT STRING,
    GYEAR INT,
    GDATE INT,
    APPYEAR STRING,
    COUNTRY STRING,
    POSTATE STRING,
    ASSIGNEE STRING,
    ASSCODE INT,
    CLAIMS STRING,
    NCLASS INT,
    CAT INT,
    SUBCAT INT,
    CMADE STRING,
    CRECEIVE STRING,
    RATIOCIT STRING,
    GENERAL STRING,
    ORIGINAL STRING,
    FWDAPLAG STRING,
    BCKGTLAG STRING,
    SELFCTUB STRING,
    SELFCTLB STRING,
    SECDUPBD STRING,
    SECDLWBD STRING
)
USING csv
OPTIONS (
    path '/input/data2.txt',
    header 'true',        
    delimiter ',',        
    inferSchema 'true'    
);
</code></pre>
<img src="static/assets/img/sparksql/create2.png" alt="create2" style="width: 100%; height: auto;"/>
                <ul>
                    <li>查询四 年份或国家专利数统计</li>
                    <li>这里我们可以将查询的结果作为文件保存到hdfs上</li>
                </ul>
                <pre><code>CREATE TABLE patent_count_by_year_country
USING csv
OPTIONS (
    path '/output/patent_count_by_year_country',
    header 'true'
) AS
SELECT 
    GYEAR, 
    COUNTRY, 
    COUNT(*) AS patent_count
FROM 
    patent_metadata
GROUP BY 
    GYEAR, 
    COUNTRY limit 10;
</code></pre>
<img src="static/assets/img/sparksql/query4.png" alt="query4" style="width: 100%; height: auto;"/>
<br><br>
                <p><strong>（5）HDFS上查看 <strong>查询四</strong> 的结果</strong></p>
                
                <ul>
                    <li>所有的查询结果都以文件的形式存放在对应目录下</li>
                </ul>
                
                <ul>
                    <li>我们可以在HDFS上看到我们查询得到的结果，在浏览器访问下面的链接（这里如果访问不到，则是在部署Hadoop环境时没有在命令行转发端口）</li>
                </ul>
<p><a href="http://localhost:9870/" target="_blank">http://localhost:9870/</a></p>

                <ul>
                    <li>再打开对应目录，我们能看到刚刚查询所得到的结果都被放在对应的文件夹中，打开某一文件夹，可以看到这里的part-00000-55438a7f-e434-4970-913b4d960374a4d7-c000.csv即为我们查询得到的结果文件，_SUCCESS则是任务成功的标志文件</li>
                </ul>
<img src="static/assets/img/sparksql/show1.png" alt="show1" style="width: 100%; height: auto;"/>
<br><br>
<img src="static/assets/img/sparksql/show2.png" alt="show2" style="width: 100%; height: auto;"/>
                <ul>
                    <li>接着我们回到命令行，先使用ctrl+c退出spark-sql，回到nodemanager-0所在的pod中，我们可以查看查询结果，这里的part-00000-311c6b33-5115-4410-bf5f-0b78e333b448-c000.csv需要替换为实际生成的文件</li>
                </ul>

                <pre><code>hdfs dfs -cat /output/patent_count_by_year_country/part-00000-311c6b33-5115-4410-bf5f-0b78e333b448-c000.csv
</code></pre>

<img src="static/assets/img/sparksql/show3.png" alt="show3" style="width: 100%; height: auto;"/>
                
                


            </div>

        </div>
    </section>
    <!-- Awards -->


    <!-- Footer-->
    <footer class="bg-bottom text-center py-5">
        <div class="container px-5">

        </div>
    </footer>

</body>

</html>