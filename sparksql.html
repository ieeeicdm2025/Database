<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="Academic Webpage" />
    <meta name="author" content="senli1073" />
    <title id="title"></title>

    <!-- Icon -->
    <link rel="icon" type="image/x-icon" href="static/assets/favicon.ico" />

    <!-- Bootstrap icons-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" />

    <!-- Google fonts-->
    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link href="https://fonts.googleapis.com/css2?family=Newsreader:ital,wght@0,600;1,600&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Mulish:ital,wght@0,300;0,500;0,600;0,700;1,300;1,500;1,600;1,700&amp;display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Kanit:ital,wght@0,400;1,400&amp;display=swap"
        rel="stylesheet" />

    <!-- Core theme CSS (includes Bootstrap)-->
    <link type="text/css" href="static/css/styles.css" rel="stylesheet" />
    <link type="text/css" href="static/css/main.css" rel="stylesheet" />

    <!-- Bootstrap core JS-->
    <script type="text/javascript" src="static/js/bootstrap.bundle.min.js"></script>

    <style>
        pre {
            background-color: #f4f4f4;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
            font-family: monospace;
        }

        code {
            color: #333;
        }
    </style>

    <!-- For Compatability -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>

    <!-- Markdown -->
    <script type="text/javascript" src="static/js/marked.min.js"></script>

    <!-- Mathematics -->
    <script>
        // See https://docs.mathjax.org/en/latest/index.html for more details.
        MathJax = {
            tex: {
                packages: {},              // extensions to use
                inlineMath: [              // start/end delimiter pairs for in-line math
                    ['$', '$'],
                    ['\\(', '\\)']
                ],
                displayMath: [             // start/end delimiter pairs for display math
                    ['$$', '$$'],
                    ['\\[', '\\]']
                ],
                processEscapes: false,      // use \$ to produce a literal dollar sign
                processEnvironments: true, // process \begin{xxx}...\end{xxx} outside math mode
                processRefs: true,         // process \ref{...} outside of math mode
                digits: /^(?:[0-9]+(?:\{,\}[0-9]{3})*(?:\.[0-9]*)?|\.[0-9]+)/,    // pattern for recognizing numbers
                tags: 'all',              // or 'ams' or 'all'
                tagSide: 'right',          // side for \tag macros
                tagIndent: '0.8em',        // amount to indent tags
                useLabelIds: true,         // use label name rather than tag for ids
                maxMacros: 10000,          // maximum number of macro substitutions per expression
                maxBuffer: 5 * 1024,       // maximum size for the internal TeX string (5K)
                // baseURL:                   // URL for use with links to tags (when there is a <base> tag in effect)
                // (document.getElementsByTagName('base').length === 0) ? '' : String(document.location).replace(/#.*$/, ''),
                formatError:               // function called when TeX syntax errors occur
                    (jax, err) => jax.formatError(err)
            }
        };
    </script>
    <script type="text/javascript" id="MathJax-script"
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
    <script type="text/javascript" id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- Core JS-->
    <script type="text/javascript" src="static/js/scripts.js"></script>
    <script type="text/javascript" src="static/js/js-yaml.min.js"></script>

</head>

<body id="page-top">
    <!-- Navigation-->
    <nav class="header navbar navbar-expand-lg navbar-light fixed-top shadow-sm" id="mainNav">
        <div class="container px-5">
            <a id="page-top-title" class="navbar-brand fw-bold" href="#page-top"></a>
            <!-- <a href="#page-top"><img src="static/assets/img/CUMT_LOGO.svg" style="width: 11rem;"></a> -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive"
                aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                MENU
                <i class="bi-list"></i>
            </button>
            <div class="collapse navbar-collapse" id="navbarResponsive">
                <ul class="navbar-nav ms-auto me-4 my-3 my-lg-0">
                    <li class="nav-item">
                        <a class="nav-link me-lg-3" href="index.html" style="font-size: 30px;">首页</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link me-lg-3" href="expriment.html" style="font-size: 30px;">实验指南</a>
                    </li>
                    <!-- <li class="nav-item">
                        <a class="nav-link me-lg-3" href="ppt.html" style="font-size: 30px;"><strong>PPT</strong></a>
                    </li> -->

                </ul>
            </div>
        </div>
    </nav>

    <!-- Top Section -->
    <section class="top-section" style="background-image: url('static/assets/img/background.jpeg');">
        <div class="top-section-content">
            <div class="container px-5">
                <h2 id="top-section-bg-text" class="text-white display-3 lh-1 font-alt"></h2>
            </div>
        </div>
    </section>
    <!-- Top Section -->

    <!-- Photo -->
    <div class="container px-5">
        <div id="avatar">
            <img class="shadow" src="static/assets/img/photo.png">
        </div>
    </div>
    <!-- Photo -->

    <!-- Home -->
    <section class="bg-gradient-primary-to-secondary-light mt5 md5" id="home">
        <div class="container px-5">
            <header>
                <h2 id="home-subtitle"> </h2>
                <!-- <span class="bi bi-list"></span> -->
            </header>
            <div class="main-body" id="home-md"></div>
        </div>
    </section>
    <!-- Home -->



    <!-- Awards -->
    <section class="bg-gradient-primary-to-secondary-light mt5 md5" id="awards">
        <div class="container px-5">
            <header>
                <h2 id="awards-subtitle" style="font-size: 48px;"><i class="bi bi-award-fill"></i> 实验指南(六)：SparkSQL
                </h2>
            </header>

            <div style="height: 64px;"></div>

            <div class="main-body" id="awards-md">


                <h1 id="sparksql"><strong>SparkSQL（<a
                    href="https://spark.apache.org/sql/" target="_blank">官网</a>）</strong></h1>
                <div style="height: 32px;"></div>
                <h2 id="1-4"><strong>1、简介</strong></h2>
                <p>Spark SQL 是 Apache Spark 提供的一个模块，用于处理结构化数据，它使得用户能够在 Spark 上执行 SQL 查询、访问数据源、以及将 Spark 与 SQL 生态系统（如
                    Hive）无缝集成。</p>
                <img src="static/assets/img/sparksql_hive/sparksql_achi.png" alt="sparksql_achi" style="width: 100%; height: auto;"/>
                <br><br>
                <h2 id="2sparksql"><strong>2、SparkSQL的核心概念</strong></h2>
                <p><strong>（1）Catalyst 查询优化器</strong></p>
                <ul>
                    <li>Catalyst 是 Spark SQL 的核心组件之一，它是一个通用的查询优化器，用于优化查询计划。优化过程可以分为下面几个阶段：</li>
                    <li>解析：将 SQL 查询解析成逻辑查询计划</li>
                    <li>分析：将逻辑查询计划分析成物理查询计划</li>
                    <li>优化：使用多种规则对查询计划进行优化（例如，投影下推、谓词下推等）</li>
                    <li>生成代码：根据物理计划生成 Java 字节码进行执行</li>
                </ul>
                
                <p><strong>（2）Tungsten 执行引擎</strong></p>
                <ul>
                    <li>Tungsten 是 Spark SQL 的执行引擎，它主要关注物理执行优化，旨在通过内存管理、代码生成和硬件优化等技术提升 Spark SQL 的执行效率。</li>
                </ul>
                <p><strong>（3）DataFrame 和 DataSet</strong></p>
                <ul>
                    <li>DataFrame：是 Spark 中的一个不可变的分布式数据集，它类似于关系型数据库中的表或数据框。DataFrame API 提供了基于 SQL
                        查询的数据操作接口，支持对结构化数据进行查询、过滤、聚合等操作。</li>
                    <li>DataSet：是 DataFrame 的强类型版本，它结合了 RDD 和 DataFrame 的优点，能够提供编译时类型检查，同时支持 SQL 查询优化。</li>
                </ul>
                <h2 id="3minikubesparksql"><strong>3、使用minikube部署SparkSQL</strong></h2>
                <p><strong>（1）由于sparksql不适用于cluster模式，因此单独建立一个local模式的pod来进行实验</strong>
                </p>
                <img src="static/assets/img/sparksql_hive/sparksql_local.png" alt="sparksql_local" style="width: 100%; height: auto;"/>
                
                <ul>
                    <li>使用sparksql-deployment.yaml文件部署spark-local环境</li>
                </ul>
                <pre><code>kubectl apply -f sparksql-deployment.yaml
</code></pre>
                <ul>
                    <li>查看pod状态，确认已正常运行</li>
                </ul>
                <pre><code>kubectl get pods
</code></pre>
<img src="static/assets/img/sparksql_hive/sparksql_run.png" alt="sparksql_run" style="width: 100%; height: auto;"/>

                <p><strong>（2）使用SparkSQL进行查询</strong></p>
                <ul>
                    <li>复制数据原文件到spark-local所在的pod中，下面命令中需要替换为自己的spark-local所在的pod名</li>
                </ul>
                <pre><code>kubectl cp data1.txt spark-local-5549987b6c-pk5vx:/opt/spark/work-dir
kubectl cp data2.txt spark-local-5549987b6c-pk5vx:/opt/spark/work-dir
</code></pre>
                <ul>
                    <li>进入spark-local所在的pod</li>
                </ul>
                <pre><code>kubectl exec -it spark-local-5549987b6c-pk5vx -- bash
</code></pre>
                <ul>
                    <li>启动sparksql</li>
                </ul>
                <pre><code>spark-sql
</code></pre>
                <p><strong>（3）进行专利文献数据查询cite75_99.txt</strong></p>
                <ul>
                    <li>建立表格并导入文件数据</li>
                </ul>
                <pre><code>CREATE TABLE patents (
    CITING STRING,
    CITED STRING
)
USING csv
OPTIONS (path '/opt/spark/work-dir/data1.txt', header 'true', delimiter ',');
</code></pre>
<img src="static/assets/img/sparksql_hive/sparksql1.png" alt="sparksql1" style="width: 100%; height: auto;"/>

                <ul>
                    <li>查询一 被引用列表</li>
                </ul>
                <pre><code>CREATE TABLE citation_results
USING csv
OPTIONS (
    path '/opt/spark/work-dir/output/citation_results',
    header 'true'
) AS
SELECT 
    CITED, 
    CONCAT_WS(',', COLLECT_LIST(CITING)) AS CITING_AGG
FROM 
    patents
GROUP BY 
    CITED;
</code></pre>
<img src="static/assets/img/sparksql_hive/sparksql2.png" alt="sparksql2" style="width: 100%; height: auto;"/>
                <ul>
                    <li>查询二 被引用次数</li>
                </ul>
                <pre><code>CREATE TABLE citation_count_results
USING csv
OPTIONS (
    path '/opt/spark/work-dir/output/citation_count_results',
    header 'true'
) AS
SELECT
    cited,
    COUNT(*) AS citation_count
FROM
    patents
GROUP BY
    cited;
</code></pre>
<img src="static/assets/img/sparksql_hive/sparksql3.png" alt="sparksql3" style="width: 100%; height: auto;"/>
                <ul>
                    <li>查询三 被引用次数直方图</li>
                    <li>先创建临时视图</li>
                </ul>
                <pre><code>CREATE OR REPLACE TEMP VIEW cite_count AS
SELECT 
    cited, 
    COUNT(*) AS ct
FROM 
    patents
GROUP BY 
    cited;
</code></pre>
                <ul>
                    <li>再进行查询</li>
                </ul>
                <pre><code>CREATE TABLE cite_count_results
USING csv
OPTIONS (
    path '/opt/spark/work-dir/output/cite_count_results',
    header 'true'
) AS
SELECT 
    ct, 
    COUNT(*) AS ct_count
FROM 
    cite_count
GROUP BY 
    ct;
</code></pre>
<img src="static/assets/img/sparksql_hive/sparksql4.png" alt="sparksql4" style="width: 100%; height: auto;"/>
<br><br>
                <p><strong>（4）进行专利文献数据查询apat63_99.txt</strong></p>
                <ul>
                    <li>先导入表</li>
                </ul>
                <pre><code>CREATE TABLE patent_details (
    PATENT STRING,
    GYEAR INT,
    GDATE INT,
    APPYEAR STRING,
    COUNTRY STRING,
    POSTATE STRING,
    ASSIGNEE STRING,
    ASSCODE INT,
    CLAIMS STRING,
    NCLASS INT,
    CAT INT,
    SUBCAT INT,
    CMADE STRING,
    CRECEIVE STRING,
    RATIOCIT STRING,
    GENERAL STRING,
    ORIGINAL STRING,
    FWDAPLAG STRING,
    BCKGTLAG STRING,
    SELFCTUB STRING,
    SELFCTLB STRING,
    SECDUPBD STRING,
    SECDLWBD STRING
)
USING csv
OPTIONS (
    path '/opt/spark/work-dir/data2.txt',
    header 'true',        
    delimiter ',',        
    inferSchema 'true'    
);
</code></pre>
<img src="static/assets/img/sparksql_hive/sparksql5.png" alt="sparksql5" style="width: 100%; height: auto;"/>
                <ul>
                    <li>查询四 年份或国家专利数统计</li>
                </ul>
                <pre><code>CREATE TABLE patent_count_by_year_country
USING csv
OPTIONS (
    path '/opt/spark/work-dir/output/patent_count_by_year_country',
    header 'true'
) AS
SELECT 
    GYEAR, 
    COUNTRY, 
    COUNT(*) AS patent_count
FROM 
    patent_details
GROUP BY 
    GYEAR, 
    COUNTRY;
</code></pre>
<img src="static/assets/img/sparksql_hive/sparksql6.png" alt="sparksql6" style="width: 100%; height: auto;"/>
<br><br>
                <p><strong>（5）所有的查询结果都以文件的形式存放在对应目录下</strong></p>
                <ul>
                    <li>先退出sql命令行</li>
                </ul>
                <pre><code>exit;
</code></pre>
                <ul>
                    <li>再打开输出目录</li>
                </ul>
                <pre><code>cd output
</code></pre>
                <ul>
                    <li>再进入对应目录查看输出文件列表</li>
                </ul>
                <img src="static/assets/img/sparksql_hive/sparksql_file1.png" alt="sparksql_file1" style="width: 100%; height: auto;"/>
                <ul>
                    <li>进入任意一个目录中</li>
                </ul>
                <pre><code>cd citation\_results
</code></pre>
                <ul>
                    <li>可以查看到文件的具体内容（下面的part-00000-96701e9c-2270-4f47-ac3e-2901da3ca863-c000.csv需替换为自己想要查看的文件名）</li>
                </ul>
                <pre><code>cat part-00000-96701e9c-2270-4f47-ac3e-2901da3ca863-c000.csv
</code></pre>
<img src="static/assets/img/sparksql_hive/sparksql_file2.png" alt="sparksql_file2" style="width: 100%; height: auto;"/>
                <div style="height: 32px;"></div>


            </div>

        </div>
    </section>
    <!-- Awards -->


    <!-- Footer-->
    <footer class="bg-bottom text-center py-5">
        <div class="container px-5">

        </div>
    </footer>

</body>

</html>